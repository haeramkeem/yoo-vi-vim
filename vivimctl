#!/bin/bash
# vim: set ft=sh:

# Init VIVIMCTL --------------------------------------------------------------
VERSION="v0.1.1"

# env
if [[ -f $HOME/.vivimrc ]]; then source $HOME/.vivimrc; fi
VIVIM_PATH=${VIVIM_PATH:="."}

# error
function error_unknown_command() {
    local command="$1"
    local subcommand="$2"
    echo "error: Unknown subcommand or option \"$subcommand\" for \"$command\"" 1>&2
}

# SUBCOMMAND vimrc -----------------------------------------------------------
function vimrc() {
    local vimrc_src="$VIVIM_PATH/vimrc/.vimrc"
    local vimrc_dst="$HOME/.vimrc"

    case "$1" in
        help | --help | -H)
            vimrc_help
            ;;
        diff)
            vimrc_diff $vimrc_src $vimrc_dst
            ;;
        edit)
            vimrc_edit $vimrc_src
            ;;
        export)
            vimrc_export $vimrc_src $vimrc_dst
            ;;
        import)
            vimrc_import $vimrc_src $vimrc_dst
            ;;
        *)
            error_unknown_command "vivimctl vimrc" "$1"
            exit 1
            ;;
    esac
}

function vimrc_help() {
cat << EOF | column -t -s '|'
SUBCOMMAND|DESCRIPTION
diff|Compare .vimrc file for current git repository and home directory.
edit|Edit .vimrc file in VIVIM_PATH
export|Export .vimrc file from current git repository to home directory.
import|Import .vimrc file from home directory to current git repository.
EOF
}

function vimrc_diff() {
    local vimrc_src="$1"
    local vimrc_dst="$2"

    colordiff "$vimrc_dst" "$vimrc_src" \
        && echo "vimrc synced with '$HOME/.vimrc'"
}

function vimrc_edit() {
    local vimrc_src="$1"
    vi $vimrc_src
    cd $VIVIM_PATH \
    && git add $vimrc_src &> /dev/null \
    && git commit -m "autocommit: {\"target\": \"vimrc\", \"date\": \"$(date -Iseconds)\", \"uuid\": \"$(uuidgen | tr '[[:upper:]]' '[[:lower:]]')\"}" &> /dev/null \
    && echo "Changes autocommited."
    echo "Do 'vivimctl vimrc export' to export the changes"
}

function vimrc_export() {
    local vimrc_src="$1"
    local vimrc_dst="$2"

    mv "$vimrc_dst" "$vimrc_dst.bak"
    cp -v "$vimrc_src" "$vimrc_dst"
}

function vimrc_import() {
    local vimrc_src="$1"
    local vimrc_dst="$2"

    mv "$vimrc_src" "$vimrc_src.bak"
    cp -v "$vimrc_dst" "$vimrc_src"
}

# SUBCOMMAND zshrc -----------------------------------------------------------
function zshrc() {
    local zshrc_src="$VIVIM_PATH/zshrc/.zshrc"
    local zshrc_dst="$HOME/.zshrc"

    case "$1" in
        help | --help | -H)
            zshrc_help
            ;;
        diff)
            zshrc_diff $zshrc_src $zshrc_dst
            ;;
        edit)
            zshrc_edit $zshrc_src
            ;;
        export)
            zshrc_export $zshrc_src $zshrc_dst
            ;;
        import)
            zshrc_import $zshrc_src $zshrc_dst
            ;;
        *)
            error_unknown_command "vivimctl zshrc" "$1"
            exit 1
            ;;
    esac
}

function zshrc_help() {
cat << EOF | column -t -s '|'
SUBCOMMAND|DESCRIPTION
diff|Compare .zshrc file for current git repository and home directory.
edit|Edit .zshrc file in VIVIM_PATH
export|Export .zshrc file from current git repository to home directory.
import|Import .zshrc file from home directory to current git repository.
EOF
}

function zshrc_diff() {
    local zshrc_src="$1"
    local zshrc_dst="$2"

    colordiff "$zshrc_dst" "$zshrc_src" \
        && echo "zshrc synced with '$HOME/.zshrc'"
}

function zshrc_edit() {
    local zshrc_src="$1"
    vi $zshrc_src
    cd $VIVIM_PATH \
    && git add $zshrc_src &> /dev/null \
    && git commit -m "autocommit: {\"target\": \"zshrc\", \"date\": \"$(date -Iseconds)\", \"uuid\": \"$(uuidgen | tr '[[:upper:]]' '[[:lower:]]')\"}" &> /dev/null \
    && echo "Changes autocommited."
    echo "Do 'vivimctl zshrc export' and 'source ~/.zshrc' to export and source .zshrc in home directory"
}

function zshrc_export() {
    local zshrc_src="$1"
    local zshrc_dst="$2"

    mv "$zshrc_dst" "$zshrc_dst.bak"
    cp -v "$zshrc_src" "$zshrc_dst"
}

function zshrc_import() {
    local zshrc_src="$1"
    local zshrc_dst="$2"

    mv "$zshrc_src" "$zshrc_src.bak"
    cp -v "$zshrc_dst" "$zshrc_src"
}

# SUBCOMMAND install ---------------------------------------------------------
function install() {
    case "$1" in
        "")
            local vivim_abs_path=$(cd `dirname $0` && pwd)
            local vivim_install_path="/usr/local/bin/vivimctl"
            echo "VIVIM_PATH='$vivim_abs_path'" > $HOME/.vivimrc
            sudo ln -sf $vivim_abs_path/vivimctl /usr/local/bin/vivimctl && echo "vivimctl installed."
            ;;
        *)
            echo "error: No subcommand or option available for command \"vivimctl install\""
            exit 1
            ;;
    esac
}

# Main -----------------------------------------------------------------------
function main() {
    case "$1" in
        vimrc)
            vimrc $2
            ;;
        zshrc)
            zshrc $2
            ;;
        install)
            install $2
            ;;
        help | --help | -H)
            main_help
            ;;
        version | --version | -V)
            main_version
            ;;
        *)
            error_unknown_command "vivimctl" "$1"
            exit 1
            ;;
    esac
}

function main_help() {
cat << EOF | column -t -s '|'
SUBCOMMAND|DESCRIPTION
install|Install vivimctl by creating symlink in /usr/bin
version (--version, -V)|Print VIVIMCTL version
vimrc|Manage vim configuration file (vimrc)
zshrc|Manage zsh configuration file (zshrc)
EOF
}

function main_version() {
cat << EOF
VIVIMCTL version $VERSION

VIVIM directory path: $VIVIM_PATH
EOF
}

main $@
